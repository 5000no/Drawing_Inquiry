# 图纸查询系统 - 外网访问配置指南

## 🌐 概述

要让外网用户访问您的图纸查询系统，需要进行网络配置和安全设置。本指南提供了多种方案供您选择。

## ⚠️ 安全警告

**在开放外网访问前，请务必注意以下安全事项：**
- 修改默认管理员密码
- 启用HTTPS加密
- 配置防火墙规则
- 定期备份数据库
- 监控访问日志

## 🚀 方案选择

### 方案1：端口转发（最简单）

#### 适用场景
- 家庭/小型办公室网络
- 有固定公网IP或动态域名
- 临时或小规模访问

#### 配置步骤

**1. 路由器端口转发设置**
```
外网端口: 8080 (或其他端口)
内网IP: 192.168.14.122
内网端口: 5000
协议: TCP
```

**2. 修改应用配置**
编辑 `config.py` 文件：
```python
# 外网访问配置
EXTERNAL_ACCESS = True
EXTERNAL_PORT = 8080
ALLOWED_HOSTS = ['*']  # 允许所有域名访问，生产环境建议限制
```

**3. 防火墙配置**
```cmd
# Windows防火墙开放端口
netsh advfirewall firewall add rule name="Web App External" dir=in action=allow protocol=TCP localport=5000

# 如果使用其他端口
netsh advfirewall firewall add rule name="Web App Port 8080" dir=in action=allow protocol=TCP localport=8080
```

**4. 访问地址**
```
外网访问: http://您的公网IP:8080
内网访问: http://192.168.14.122:5000
```

### 方案2：动态域名（推荐）

#### 适用场景
- 没有固定公网IP
- 需要域名访问
- 长期稳定服务

#### 配置步骤

**1. 申请动态域名服务**
推荐服务商：
- 花生壳 (oray.com)
- No-IP (noip.com)
- DynDNS
- 阿里云DDNS

**2. 路由器DDNS设置**
```
DDNS服务商: 选择对应服务
域名: yourname.example.com
用户名: 您的账号
密码: 您的密码
```

**3. 端口转发**
```
外网端口: 80 (HTTP) 或 443 (HTTPS)
内网IP: 192.168.14.122
内网端口: 5000
```

**4. 访问地址**
```
外网访问: http://yourname.example.com
或: https://yourname.example.com (如果配置了SSL)
```

### 方案3：云服务器部署（最安全）

#### 适用场景
- 需要高可用性
- 大量外网用户访问
- 企业级应用

#### 配置步骤

**1. 购买云服务器**
推荐服务商：
- 阿里云ECS
- 腾讯云CVM
- 华为云ECS
- AWS EC2

**2. 服务器环境配置**
```bash
# 安装Python环境
sudo apt update
sudo apt install python3 python3-pip nginx

# 上传项目文件
scp -r ./View_Blueprint root@服务器IP:/var/www/

# 安装依赖
cd /var/www/View_Blueprint
pip3 install -r web_requirements.txt
```

**3. Nginx反向代理配置**
创建 `/etc/nginx/sites-available/drawing-system`：
```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

**4. SSL证书配置（推荐）**
```bash
# 使用Let's Encrypt免费证书
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d your-domain.com
```

**5. 启动服务**
```bash
# 启动应用
cd /var/www/View_Blueprint
nohup python3 run_web.py &

# 启动Nginx
sudo systemctl start nginx
sudo systemctl enable nginx
```

## 🔒 安全配置

### 1. 修改管理员密码

编辑 `app.py` 文件，修改管理员登录验证：
```python
@app.route('/api/admin/login', methods=['POST'])
def admin_login():
    # 修改默认密码
    if username == 'admin' and password == '您的新密码':
        return jsonify({'success': True, 'message': '登录成功'})
```

### 2. 启用访问日志

在 `app.py` 中添加日志记录：
```python
import logging
from datetime import datetime

# 配置日志
logging.basicConfig(
    filename='access.log',
    level=logging.INFO,
    format='%(asctime)s - %(remote_addr)s - %(message)s'
)

@app.before_request
def log_request():
    logging.info(f"访问: {request.method} {request.url} - IP: {request.remote_addr}")
```

### 3. IP访问限制

添加IP白名单功能：
```python
ALLOWED_IPS = [
    '192.168.1.0/24',  # 内网
    '123.456.789.0',   # 特定外网IP
]

@app.before_request
def limit_remote_addr():
    if not is_ip_allowed(request.remote_addr):
        abort(403)  # 拒绝访问
```

### 4. 数据库安全

```python
# 数据库连接加密
DB_CONFIG = {
    'host': 'localhost',
    'user': 'drawing_user',  # 创建专用用户
    'password': '复杂密码',
    'database': 'drawing_system',
    'ssl_disabled': False,  # 启用SSL
}
```

## 📊 监控和维护

### 1. 系统监控

创建监控脚本 `monitor.py`：
```python
import psutil
import requests
from datetime import datetime

def check_system():
    # 检查CPU、内存使用率
    cpu_percent = psutil.cpu_percent()
    memory_percent = psutil.virtual_memory().percent
    
    # 检查服务是否正常
    try:
        response = requests.get('http://localhost:5000')
        service_status = "正常" if response.status_code == 200 else "异常"
    except:
        service_status = "离线"
    
    print(f"{datetime.now()} - CPU: {cpu_percent}% | 内存: {memory_percent}% | 服务: {service_status}")

if __name__ == "__main__":
    check_system()
```

### 2. 自动备份

创建备份脚本 `backup.py`：
```python
import os
import shutil
from datetime import datetime

def backup_database():
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    backup_file = f"backup_drawing_system_{timestamp}.sql"
    
    # MySQL备份命令
    os.system(f"mysqldump -u用户名 -p密码 drawing_system > {backup_file}")
    print(f"数据库备份完成: {backup_file}")

def backup_files():
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    backup_dir = f"backup_files_{timestamp}"
    
    # 备份PDF文件
    shutil.copytree("PDF文件目录", backup_dir)
    print(f"文件备份完成: {backup_dir}")

if __name__ == "__main__":
    backup_database()
    backup_files()
```

## 🌍 域名和SSL配置

### 免费域名选项
- Freenom (.tk, .ml, .ga)
- No-IP 子域名
- DuckDNS

### SSL证书选项
- Let's Encrypt (免费)
- 阿里云SSL证书 (免费版)
- Cloudflare SSL (免费)

## 📱 移动端优化

外网访问时，确保移动端体验：
```css
/* 添加到移动端CSS */
@media (max-width: 768px) {
    .mobile-layout {
        /* 针对外网访问优化 */
        min-height: 100vh;
        overflow-x: hidden;
    }
}
```

## 🚨 故障排除

### 常见问题

**1. 外网无法访问**
- 检查路由器端口转发设置
- 确认防火墙规则
- 验证公网IP是否正确

**2. 访问速度慢**
- 检查网络带宽
- 优化数据库查询
- 启用Gzip压缩

**3. 服务经常断线**
- 使用进程守护工具 (supervisor, pm2)
- 检查服务器资源使用情况
- 配置自动重启脚本

### 联系支持

如需技术支持，请提供：
- 错误日志
- 网络配置信息
- 访问测试结果

---

## 📋 快速配置检查清单

- [ ] 路由器端口转发配置
- [ ] 防火墙规则设置
- [ ] 管理员密码修改
- [ ] 访问日志启用
- [ ] 数据库备份配置
- [ ] SSL证书安装（可选）
- [ ] 域名解析配置（可选）
- [ ] 监控脚本部署
- [ ] 安全规则测试

**配置完成后，请从外网测试访问功能是否正常！**