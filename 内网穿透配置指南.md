# 内网穿透配置指南

适用：服务器暂时部署在本地主机（Windows），无权配置路由器或默认网关，需从外网访问 `http://localhost:5000`（Flask 已监听 `0.0.0.0:5000`）。

## 快速选择
- 想让外部用户直接用浏览器访问（无需安装客户端）：优先用 Cloudflare Tunnel（快速隧道）或 Ngrok。
- 想长期、安全、给同事内部访问（愿意在他们设备安装客户端）：用 Tailscale 或 ZeroTier（虚拟内网）。

---

## 方案一：Cloudflare Tunnel（免路由器、免域名）
最简单的“快速隧道”，直接给你一个 `*.trycloudflare.com` 公网地址。

1) 安装 cloudflared（推荐用 `winget`）
```
winget install -e --id Cloudflare.cloudflared
```
若 `winget` 不可用，可从官方发布页下载 Windows 版本并放到 PATH：
- https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/installation/#windows

2) 启动快速隧道，将本地 `5000` 端口暴露到公网
```
cloudflared tunnel --url http://localhost:5000
```
- 终端会输出一个形如 `https://xxxx.trycloudflare.com` 的地址；复制给外部用户即可访问。
- 窗口需要保持运行；关闭窗口隧道即停止。

可选增强：
- 指定日志文件：`cloudflared tunnel --url http://localhost:5000 --logfile cloudflared.log`
- 后续若需稳定、长期运行（作为服务）或自定义域名，需要在 Cloudflare 账号下创建“命名隧道”，这一步需有自己的域名并托管到 Cloudflare。

---

## 方案二：Ngrok（注册即用）
适合临时演示与快速共享，免费版会给临时域名。

1) 安装 ngrok（推荐 `winget`）
```
winget install -e --id Ngrok.Ngrok
```
或从 https://ngrok.com 下载 `ngrok.exe` 并放到 PATH。

2) 登录并配置 token（在 ngrok 官网获取）
```
ngrok config add-authtoken <你的_authtoken>
```

3) 暴露本地端口 5000
```
ngrok http 5000
```
- 终端会显示 `https://xxxx.ngrok.io` 地址，外部直接访问即可。
- 如需简单保护，可加基本认证：
```
ngrok http 5000 --basic-auth "user:pass"
```

提示：免费计划域名不固定，隧道关闭后地址会变化；需固定域名或更高并发，请考虑付费计划或转用 Cloudflare 命名隧道。

---

## 方案三：Tailscale（零信任虚拟内网）
让你的电脑获得一个 `100.x.y.z` 的私有虚拟IP，外部设备安装 Tailscale 后可直接访问你的服务，安全、稳定、无需改路由器。

1) 安装并登录
```
winget install -e --id Tailscale.Tailscale
```
安装后用你的账号登录（Microsoft/Google 等均可）。

2) 在外部访问设备也安装并登录同一账号。

3) 获取本机的 Tailscale IP（在服务器电脑）
```
tailscale ip -4
```
得到如 `100.xxx.xxx.xxx`，外部设备用浏览器访问：
```
http://<tailscale_ip>:5000/
```

建议：在 Tailscale 管理后台配置 ACL，只允许指定设备访问；可开启 MagicDNS 以设备名访问。

---

## 方案四：ZeroTier（虚拟局域网）
与 Tailscale 类似，创建一个虚拟 LAN，把你的电脑和外部设备加入同一个网络后，直接用分配的虚拟IP访问。

1) 安装 ZeroTier
```
winget install -e --id ZeroTier.ZeroTierOne
```

2) 在 https://my.zerotier.com 创建网络，获取 `Network ID`。

3) 在两端设备加入同一网络：
- Windows GUI 里“加入网络”填入 `Network ID`；或命令行：
```
zerotier-cli join <NetworkID>
```

4) 在 ZeroTier 控制台“授权”设备后，查看各自的虚拟IP，用浏览器访问：
```
http://<zerotier_ip>:5000/
```

---

## 测试与安全建议
- 服务器当前监听：`0.0.0.0:5000`（已满足远程访问的前提）。
- Windows 防火墙的 5000/TCP 入站规则只影响局域网直连；Cloudflare/Ngrok/Tailscale/ZeroTier 通常无需额外放行。
- 不要把数据库或敏感端口暴露在隧道上；若必须公开，至少加认证（如 Ngrok `--basic-auth`）。
- Cloudflare 快速隧道与 Ngrok 免费计划域名会变化；生产场景建议命名隧道或自有域名。

## 常见问题
- 打开隧道后仍无法访问：确认本地服务已启动、端口未被占用（`netstat -an | findstr :5000`）。
- 企业/小区网络的默认网关（如 `192.168.15.254`）不可管理：这正是上述内网穿透的适用场景。
- 连接偶发中断：避免睡眠/休眠；对 Cloudflare/Ngrok 保持终端前台运行或配置为服务（命名隧道）。

## 小结
- 立即对外演示：优先 Cloudflare Tunnel（`cloudflared tunnel --url http://localhost:5000`）。
- 稳定内部协作：优先 Tailscale/ZeroTier。
- 需要我帮你选择并落地某一条方案，可直接告诉我你的偏好（临时演示/长期访问/是否能让对方安装客户端）。